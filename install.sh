#!/bin/bash
# Server Security Toolkit - One-line installer
# Usage: bash <(curl -Ls https://raw.githubusercontent.com/Escanor-87/server-security-toolkit/main/install.sh)

set -euo pipefail

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
readonly REPO_URL="https://github.com/Escanor-87/server-security-toolkit.git"
readonly INSTALL_DIR="/opt/server-security-toolkit"
readonly SYMLINK_PATH="/usr/local/bin/security-toolkit"

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒÑÑ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ root"
        log_info "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: sudo bash <(curl -Ls https://raw.githubusercontent.com/Escanor-87/server-security-toolkit/main/install.sh)"
        exit 1
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞĞ¡
check_os() {
    if [[ ! -f /etc/os-release ]]; then
        log_error "ĞĞµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ"
        exit 1
    fi
    
    # shellcheck disable=SC1091
    source /etc/os-release
    
    case "$ID" in
        ubuntu)
            log_info "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ğ°Ñ ĞĞ¡: $PRETTY_NAME"
            ;;
        debian)
            if [[ "$VERSION_ID" == "12" ]]; then
                log_info "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ğ°Ñ ĞĞ¡: $PRETTY_NAME"
            else
                log_warning "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Debian $VERSION_ID. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Debian 12"
                log_info "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° ĞĞ¡: $PRETTY_NAME"
                read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ? (y/N): " -n 1 -r
                echo
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    log_info "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"
                    exit 1
                fi
            fi
            ;;
        *)
            log_warning "Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ´Ğ»Ñ Ubuntu Ğ¸ Debian 12"
            log_info "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° ĞĞ¡: $PRETTY_NAME"
            read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                log_info "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"
                exit 1
            fi
            ;;
    esac
}

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
install_dependencies() {
    log_info "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
    
    apt update
    apt install -y git curl wget
    
    log_success "Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹"
}

# ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
clone_repository() {
    log_info "ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Server Security Toolkit..."
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ
    if [[ -d "$INSTALL_DIR" ]]; then
        log_warning "ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ² $INSTALL_DIR"
        read -p "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$INSTALL_DIR"
            log_info "Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
            # ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
            git clone "$REPO_URL" "$INSTALL_DIR"
            log_success "Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ² $INSTALL_DIR"
        else
            log_info "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ"
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
            log_success "Ğ—Ğ°Ğ¿ÑƒÑĞº ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Security Toolkit..."
            exec "$INSTALL_DIR/main.sh"
        fi
    else
        # ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ (Ğ½Ğ¾Ğ²Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°)
        git clone "$REPO_URL" "$INSTALL_DIR"
        log_success "Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ ÑĞºĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² $INSTALL_DIR"
    fi
}

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
setup_permissions() {
    log_info "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°..."
    
    cd "$INSTALL_DIR"
    chmod +x main.sh modules/*.sh tests/*.sh
    
    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ°Ğ»Ğ¸Ğ°Ñ ss ĞµÑĞ»Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
    if [[ -L "/usr/local/bin/ss" ]] || [[ -f "/usr/local/bin/ss" ]]; then
        rm "/usr/local/bin/ss"
        log_info "Ğ£Ğ´Ğ°Ğ»ĞµĞ½ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ°Ğ»Ğ¸Ğ°Ñ ss"
    fi
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
    if [[ -L "$SYMLINK_PATH" ]] || [[ -f "$SYMLINK_PATH" ]]; then
        rm "$SYMLINK_PATH"
    fi
    ln -s "$INSTALL_DIR/main.sh" "$SYMLINK_PATH"
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ°Ğ»Ğ¸Ğ°Ñ sst
    local short_alias="/usr/local/bin/sst"
    if [[ -L "$short_alias" ]] || [[ -f "$short_alias" ]]; then
        rm "$short_alias"
    fi
    ln -s "$INSTALL_DIR/main.sh" "$short_alias"
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚
    if [[ -L "$SYMLINK_PATH" ]] && [[ -f "$(readlink -f "$SYMLINK_PATH")" ]]; then
        log_success "Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑÑ‹Ğ»ĞºĞ° security-toolkit ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ°"
    else
        log_warning "ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ security-toolkit"
    fi
    
    if [[ -L "$short_alias" ]] && [[ -f "$(readlink -f "$short_alias")" ]]; then
        log_success "ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ°Ğ»Ğ¸Ğ°Ñ sst ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½"
    else
        log_warning "ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ°Ğ»Ğ¸Ğ°ÑĞ¾Ğ¼ sst"
    fi
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ğ»Ğ¸Ğ°ÑÑ‹ Ğ´Ğ»Ñ fail2ban
    create_fail2ban_aliases
    
    log_success "ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹"
    log_info "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑÑ‹Ğ»ĞºĞ°: $SYMLINK_PATH"
}

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ğ»Ğ¸Ğ°ÑĞ¾Ğ² Ğ´Ğ»Ñ fail2ban
create_fail2ban_aliases() {
    log_info "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ğ»Ğ¸Ğ°ÑĞ¾Ğ² Ğ´Ğ»Ñ fail2ban..."
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚-Ğ¾Ğ±ĞµÑ€Ñ‚ĞºÑƒ Ğ´Ğ»Ñ fail2ban
    cat > /usr/local/bin/f2b << 'EOF'
#!/bin/bash
# fail2ban alias wrapper

case "${1:-help}" in
    "list"|"l")
        if ! command -v fail2ban-client &>/dev/null; then
            echo "âŒ fail2ban Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
            exit 1
        fi
        
        echo "ğŸ”’ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ fail2ban Ğ¸ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ IP:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº jail'Ğ¾Ğ²
        jails=$(fail2ban-client status 2>/dev/null | grep "Jail list:" | sed 's/.*Jail list://' | tr ',' ' ')
        
        if [[ -z "$jails" ]]; then
            echo "âš ï¸  ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… jail'Ğ¾Ğ²"
            exit 0
        fi
        
        total_banned=0
        for jail in $jails; do
            jail=$(echo "$jail" | xargs)  # trim whitespace
            if [[ -n "$jail" ]]; then
                jail_status=$(fail2ban-client status "$jail" 2>/dev/null)
                banned_count=$(echo "$jail_status" | grep "Currently banned:" | awk '{print $3}')
                banned_ips=$(echo "$jail_status" | grep "Banned IP list:" | sed 's/.*Banned IP list://')
                
                echo "ğŸ“‹ Jail: $jail"
                echo "   Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${banned_count:-0} IP"
                if [[ -n "$banned_ips" && "$banned_ips" != " " ]]; then
                    echo "   IP Ğ°Ğ´Ñ€ĞµÑĞ°: $banned_ips"
                    if [[ "$banned_count" =~ ^[0-9]+$ ]]; then
                        total_banned=$((total_banned + banned_count))
                    fi
                fi
                echo
            fi
        done
        
        echo "ğŸ“Š Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ IP: $total_banned"
        ;;
    "status"|"s")
        echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ fail2ban:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        fail2ban-client status
        ;;
    "unban"|"u")
        if [[ -z "$2" ]]; then
            echo "âŒ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ IP Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸: f2b unban <IP>"
            exit 1
        fi
        echo "ğŸ”“ Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° IP: $2"
        fail2ban-client set sshd unbanip "$2"
        ;;
    "ban"|"b")
        if [[ -z "$2" ]]; then
            echo "âŒ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ IP Ğ´Ğ»Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸: f2b ban <IP>"
            exit 1
        fi
        echo "ğŸ”’ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° IP: $2"
        fail2ban-client set sshd banip "$2"
        ;;
    "reload"|"r")
        echo "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° fail2ban..."
        systemctl reload fail2ban
        echo "âœ… fail2ban Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½"
        ;;
    "log"|"logs")
        echo "ğŸ“‹ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ fail2ban:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        journalctl -u fail2ban -n 20 --no-pager
        ;;
    "help"|"h"|*)
        echo "ğŸ›¡ï¸  fail2ban Quick Commands (f2b):"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "f2b list     (l) - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ IP"
        echo "f2b status   (s) - Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ fail2ban"
        echo "f2b ban <IP> (b) - Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ IP"
        echo "f2b unban <IP> (u) - Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ IP"
        echo "f2b reload   (r) - ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ fail2ban"
        echo "f2b log      - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸"
        echo "f2b help     (h) - Ğ­Ñ‚Ğ° ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ°"
        ;;
esac
EOF
    
    chmod +x /usr/local/bin/f2b
    
    if [[ -f /usr/local/bin/f2b ]]; then
        log_success "ĞĞ»Ğ¸Ğ°Ñ f2b ÑĞ¾Ğ·Ğ´Ğ°Ğ½ (fail2ban quick commands)"
        log_info "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: f2b list, f2b status, f2b ban <IP>, f2b unban <IP>"
    else
        log_warning "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ğ»Ğ¸Ğ°Ñ f2b"
    fi
}

# ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ
show_installation_info() {
    echo
    log_success "ğŸ‰ Server Security Toolkit ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!"
    echo
    echo "ğŸ“ Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: $INSTALL_DIR"
    echo "ğŸ”— ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: sst | security-toolkit | f2b"
    echo
    echo "ğŸš€ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚:"
    echo "   sudo sst             # Security Toolkit"
    echo "   f2b list             # fail2ban ÑÑ‚Ğ°Ñ‚ÑƒÑ"
    echo "   f2b help             # fail2ban ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹"
    echo "   sudo security-toolkit"
    echo
    echo "ğŸ“‹ Ğ˜Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ:"
    echo "   cd $INSTALL_DIR"
    echo "   sudo ./main.sh"
    echo
    echo "ğŸ”§ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸:"
    echo "   1. SSH Security â†’ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ĞºĞ»ÑÑ‡ĞµĞ¹"
    echo "   2. SSH Security â†’ Ğ¡Ğ¼ĞµĞ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ğ°"
    echo "   3. Firewall Setup â†’ Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°"
    echo "   4. System Hardening â†’ fail2ban + Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
    echo
    echo "âš¡ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°:"
    echo "   sudo security-toolkit â†’ 4. Full Security Setup"
    echo
}

# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
main() {
    echo -e "${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘       Server Security Toolkit Installer         â•‘"
    echo "â•‘            One-line Installation                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo
    
    check_root
    check_os
    install_dependencies
    clone_repository
    setup_permissions
    show_installation_info
}

# Ğ—Ğ°Ğ¿ÑƒÑĞº ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸
main "$@"
