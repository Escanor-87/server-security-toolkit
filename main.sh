#!/bin/bash

# Server Security Toolkit v1.0
# ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ubuntu ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²

set -euo pipefail

# Ğ’ĞµÑ€ÑĞ¸Ñ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
VERSION="1.0.0"

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° - Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ SC2155
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly MODULES_DIR="${SCRIPT_DIR}/modules"
readonly LOGS_DIR="${SCRIPT_DIR}/logs"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ»Ğ¾Ğ³Ğ¾Ğ²
mkdir -p "$LOGS_DIR"

# Ğ¤Ğ°Ğ¹Ğ» Ğ»Ğ¾Ğ³Ğ¾Ğ² - Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ SC2155  
readonly LOG_FILE="${LOGS_DIR}/security-$(date +%Y%m%d_%H%M%S).log"

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°
show_header() {
    clear
    echo -e "${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         Server Security Toolkit v${VERSION}         â•‘"
    echo "â•‘          Ubuntu Server Hardening Script          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒÑÑ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ root"
        log_info "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: sudo bash $0"
        exit 1
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ - Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ SC1091
check_os() {
    if [[ ! -f /etc/os-release ]]; then
        log_error "ĞĞµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ"
        exit 1
    fi
    
    # shellcheck disable=SC1091
    source /etc/os-release
    
    if [[ "$ID" != "ubuntu" ]]; then
        log_warning "Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ´Ğ»Ñ Ubuntu"
        log_info "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° ĞĞ¡: $PRETTY_NAME"
        read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼"
            exit 1
        fi
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
check_requirements() {
    local missing_tools=()
    local required_tools=("ssh" "systemctl" "sed" "grep" "awk")
    
    for tool in "${required_tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        log_error "ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹: ${missing_tools[*]}"
        exit 1
    fi
}

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹
load_modules() {
    for module in "${MODULES_DIR}"/*.sh; do
        if [[ -f "$module" ]]; then
            # shellcheck source=/dev/null
            source "$module"
        fi
    done
}

# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
show_menu() {
    show_header
    echo "ğŸ”§ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:"
    echo
    echo "1. ğŸ” SSH Security - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ SSH"
    echo "2. ğŸ›¡ï¸  Firewall Setup - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ„Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ»Ğ° UFW"
    echo "3. ğŸ”§ System Hardening - Ğ£ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"
    echo "4. ğŸš€ Full Security Setup - ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"
    echo "5. â„¹ï¸  System Information - Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ"
    echo "6. ğŸ“‹ View Logs - ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²"
    echo "0. ğŸšª Exit - Ğ’Ñ‹Ñ…Ğ¾Ğ´"
    echo
    echo -n "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ [0-6]: "
}

# Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ - Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ SC2155
show_system_info() {
    show_header
    log_info "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ:"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Hostname: $(hostname)"
    echo "OS: $(lsb_release -d 2>/dev/null | cut -f2 || echo "Unknown")"
    echo "Kernel: $(uname -r)"
    echo "Uptime: $(uptime -p 2>/dev/null || uptime)"
    
    local ssh_status
    ssh_status=$(systemctl is-active ssh 2>/dev/null || echo "unknown")
    echo "SSH Service: $ssh_status"
    
    # SSH ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
    if [[ -f /etc/ssh/sshd_config ]]; then
        local ssh_port
        local password_auth
        ssh_port=$(grep "^Port" /etc/ssh/sshd_config | awk '{print $2}' || echo "22")
        password_auth=$(grep "^PasswordAuthentication" /etc/ssh/sshd_config | awk '{print $2}' || echo "yes")
        echo "SSH Port: $ssh_port"
        echo "Password Auth: $password_auth"
    fi
    
    # UFW ÑÑ‚Ğ°Ñ‚ÑƒÑ
    if command -v ufw &>/dev/null; then
        echo "UFW Status: $(ufw status | head -1)"
    else
        echo "UFW Status: not installed"
    fi
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²
view_logs() {
    show_header
    if [[ -f "$LOG_FILE" ]]; then
        log_info "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ°:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        cat "$LOG_FILE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    else
        log_warning "Ğ¤Ğ°Ğ¹Ğ» Ğ»Ğ¾Ğ³Ğ° Ğ¿ÑƒÑÑ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
    fi
}

# ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
full_security_setup() {
    show_header
    log_warning "ğŸš€ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"
    echo
    echo "Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚:"
    echo "  1. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ SSH Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"
    echo "  2. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ„Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ»Ğ°"
    echo "  3. Ğ£ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"
    echo
    read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        return 0
    fi
    
    configure_ssh_security
    configure_firewall  
    system_hardening
    
    log_success "ğŸ‰ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!"
}

# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
main() {
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    check_root
    check_os
    check_requirements
    
    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸
    load_modules
    
    # Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»
    while true; do
        show_menu
        read -r choice
        echo
        
        case $choice in
            1) configure_ssh_security ;;
            2) configure_firewall ;;
            3) system_hardening ;;
            4) full_security_setup ;;
            5) show_system_info ;;
            6) view_logs ;;
            0) 
                log_info "Ğ”Ğ¾ ÑĞ²Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ! ğŸ‘‹"
                exit 0
                ;;
            *)
                log_error "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€: '$choice'"
                sleep 2
                continue
                ;;
        esac
        
        echo
        echo -e "${YELLOW}ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ...${NC}"
        read -r
    done
}

# Ğ—Ğ°Ğ¿ÑƒÑĞº
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
