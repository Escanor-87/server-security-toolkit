#!/bin/bash

# üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï SSH –î–û–°–¢–£–ü–ê
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSH –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï SSH –î–û–°–¢–£–ü–ê"
echo "========================================"
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ root
if [[ $EUID -ne 0 ]]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ root"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo $0"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_info() {
    echo "‚ÑπÔ∏è  $1"
}

log_success() {
    echo "‚úÖ $1"
}

log_error() {
    echo "‚ùå $1"
}

log_warning() {
    echo "‚ö†Ô∏è  $1"
}

echo "–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å SSH?"
echo "1. üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"
echo "2. üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSH –ø–æ—Ä—Ç –Ω–∞ 22"
echo "3. üõ°Ô∏è  –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ SSH –ø–æ—Ä—Ç—ã –≤ UFW (–≤—Ä–µ–º–µ–Ω–Ω–æ)"
echo "4. üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å SSH —Å–ª—É–∂–±—É"
echo "5. üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
echo "6. üîô –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–µ–∫–∞–ø–∞"
echo "0. üö™ –í—ã—Ö–æ–¥"
echo

read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ [0-6]: " -n 1 -r choice
echo
echo

case $choice in
    1)
        log_info "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSH"
        echo "==================="
        
        echo "üìã –¢–µ–∫—É—â–∏–π SSH –ø–æ—Ä—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
        grep "^Port" /etc/ssh/sshd_config 2>/dev/null || echo "–ü–æ—Ä—Ç –Ω–µ –∑–∞–¥–∞–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 22)"
        
        echo
        echo "üî• –°—Ç–∞—Ç—É—Å SSH —Å–ª—É–∂–±—ã:"
        systemctl status ssh --no-pager -l
        
        echo
        echo "üõ°Ô∏è  –°—Ç–∞—Ç—É—Å UFW:"
        ufw status numbered
        
        echo
        echo "üîç –ê–∫—Ç–∏–≤–Ω—ã–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:"
        ss -tlnp | grep ssh || echo "SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        
        echo
        echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ SSH –ª–æ–≥–∞:"
        journalctl -u ssh -n 10 --no-pager
        ;;
        
    2)
        log_info "üîß –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï SSH –ü–û–†–¢–ê –ù–ê 22"
        echo "=================================="
        
        # –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø
        cp /etc/ssh/sshd_config "/etc/ssh/sshd_config.emergency_backup.$(date +%Y%m%d_%H%M%S)"
        log_success "–°–æ–∑–¥–∞–Ω –±–µ–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—Ç 22
        if grep -q "^Port" /etc/ssh/sshd_config; then
            sed -i 's/^Port.*/Port 22/' /etc/ssh/sshd_config
        else
            echo "Port 22" >> /etc/ssh/sshd_config
        fi
        log_success "SSH –ø–æ—Ä—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 22"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        if sshd -t; then
            log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SSH –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
            systemctl restart ssh
            log_success "SSH —Å–ª—É–∂–±–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞"
        else
            log_error "–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH!"
            sshd -t
        fi
        ;;
        
    3)
        log_info "üõ°Ô∏è  –û–¢–ö–†–´–¢–ò–ï –í–°–ï–• SSH –ü–û–†–¢–û–í –í UFW"
        echo "=================================="
        
        if command -v ufw &>/dev/null; then
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ SSH –ø–æ—Ä—Ç—ã
            for port in 22 2222 2200 2022; do
                ufw allow $port/tcp comment "Emergency SSH"
                log_success "–û—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç $port/tcp"
            done
            
            ufw status numbered
        else
            log_warning "UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
        ;;
        
    4)
        log_info "üîÑ –ü–ï–†–ï–ó–ê–ü–£–°–ö SSH –°–õ–£–ñ–ë–´"
        echo "========================"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        if sshd -t; then
            log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SSH –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
            systemctl restart ssh
            if systemctl is-active --quiet ssh; then
                log_success "SSH —Å–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞"
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –∫–∞–∫–∏—Ö –ø–æ—Ä—Ç–∞—Ö —Å–ª—É—à–∞–µ—Ç SSH
                echo
                log_info "SSH —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç–∞—Ö:"
                ss -tlnp | grep ssh
            else
                log_error "SSH —Å–ª—É–∂–±–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å!"
                systemctl status ssh --no-pager
            fi
        else
            log_error "–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH!"
            sshd -t
        fi
        ;;
        
    5)
        log_info "üìã –¢–ï–ö–£–©–ê–Ø SSH –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø"
        echo "==========================="
        
        echo "–§–∞–π–ª: /etc/ssh/sshd_config"
        echo "=========================="
        grep -E "^(Port|PasswordAuthentication|PermitRootLogin|PubkeyAuthentication)" /etc/ssh/sshd_config || echo "–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
        
        echo
        echo "–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:"
        echo "======================"
        grep -v "^#" /etc/ssh/sshd_config | grep -v "^$"
        ;;
        
    6)
        log_info "üîô –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–ó –ë–ï–ö–ê–ü–ê"
        echo "=========================="
        
        # –ò—â–µ–º –±–µ–∫–∞–ø—ã
        mapfile -t backup_files < <(find /etc/ssh -name "sshd_config.backup.*" 2>/dev/null | sort -r)
        
        if [[ ${#backup_files[@]} -eq 0 ]]; then
            log_warning "–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        else
            echo "–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:"
            for i in "${!backup_files[@]}"; do
                echo "$((i+1)). $(basename "${backup_files[$i]}")"
            done
            
            echo
            read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–µ–∫–∞–ø–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è [1-${#backup_files[@]}]: " -r backup_num
            
            if [[ "$backup_num" =~ ^[0-9]+$ ]] && [[ "$backup_num" -ge 1 ]] && [[ "$backup_num" -le ${#backup_files[@]} ]]; then
                selected_backup="${backup_files[$((backup_num-1))]}"
                
                # –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
                cp /etc/ssh/sshd_config "/etc/ssh/sshd_config.before_restore.$(date +%Y%m%d_%H%M%S)"
                
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                cp "$selected_backup" /etc/ssh/sshd_config
                log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ $(basename "$selected_backup")"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
                if sshd -t; then
                    systemctl restart ssh
                    log_success "SSH —Å–ª—É–∂–±–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞"
                else
                    log_error "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏!"
                    sshd -t
                fi
            else
                log_error "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –±–µ–∫–∞–ø–∞"
            fi
        fi
        ;;
        
    0)
        log_info "–í—ã—Ö–æ–¥ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"
        exit 0
        ;;
        
    *)
        log_error "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä: '$choice'"
        ;;
esac

echo
echo "üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Æ –î–û–°–¢–£–ü–ê:"
echo "========================================="
echo "1. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ"
echo "2. –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (VNC, –∫–æ–Ω—Å–æ–ª—å) - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ"
echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ä–∞–∑–Ω—ã–º –ø–æ—Ä—Ç–∞–º: 22, 2222, 2200, 2022"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ UFW –ø—Ä–∞–≤–∏–ª–∞: sudo ufw status"
echo "5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH —Å–ª—É–∂–±—É: sudo systemctl status ssh"
echo
echo "üö® –í –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –°–ò–¢–£–ê–¶–ò–ò:"
echo "========================="
echo "sudo systemctl stop ufw    # –û—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∞–π—Ä–≤–æ–ª"
echo "sudo ufw --force reset     # –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ UFW"
echo "sudo ufw allow 22/tcp      # –û—Ç–∫—Ä—ã—Ç—å SSH"
echo "sudo ufw enable            # –í–∫–ª—é—á–∏—Ç—å UFW"
echo
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..." -r
